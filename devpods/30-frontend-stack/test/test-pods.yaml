apiVersion: v1
kind: Pod  
metadata:  
  name: devpods-30-test
  labels:
    name: devpods, frontend
spec: 
  volumes:
  - {name: "/tmp/.X11-unix", hostPath: {path: "/tmp/.X11-unix"}}
  - {name: ".vscode-server", hostPath: {path: "./test/.vscode-server"}}
  - {name: "test-data",      hostPath: {path: "./test/data"}}
  - {name: "test-workspace", hostPath: {path: "./test/workspace"}}
  containers:
  - name: frontend
    image: bizobj-container.net/pods/frontend-stack:latest
    stdin: true
    tty: true
    volumeMounts:
    - {mountPath: "/tmp/.X11-unix",       name: "/tmp/.X11-unix"}
    - {mountPath: "/root/.vscode-server", name: ".vscode-server" }
    - {mountPath: "/data",                name: "test-data" }
    - {mountPath: "/root/workspace",      name: "test-workspace" }
    env:
    - {name: "DISPLAY", value: "unix$DISPLAY"}
    command: 
    - 'bash'
    - '-ic'
    - |
      sleep 2s
      export
      set -x
      cat /etc/os-release
      node -v
      npm -v
      yarn -v
      pnpm -v
      python3 --version
      pip3 --version
      pipx --version
      uv --version
      set +x

      echo "=== Testing Python persistence configuration ==="
      echo "Environment variables:"
      env | grep -E '^(PIPX_|UV_|PYTHONUSERBASE)' || echo "Some environment variables not set"
      echo ""
      echo "Pip configuration:"
      pip config list
      echo ""
      echo "Pipx environment:"
      pipx environment
      echo ""

      echo "=== Installing pipx packages (black, ruff) ==="
      pipx install black
      pipx install ruff
      echo ""

      echo "=== Testing Python package in virtual environment ==="
      python3 -m venv /tmp/venv-test
      source /tmp/venv-test/bin/activate
      pip install requests
      echo ""

      echo "=== Verifying installation locations ==="
      echo "Directory structure in /data/python/:"
      ls -la /data/python/
      echo ""
      echo "Pipx symlinks in /data/python/pipx/bin/:"
      ls -la /data/python/pipx/bin/
      echo ""
      echo "Pipx venvs in /data/python/pipx/venvs/:"
      ls -la /data/python/pipx/venvs/
      echo ""
      echo "Pip package in virtual environment (/tmp/venv-test):"
      python3 -c "import requests; print(f'requests version: {requests.__version__}')"
      deactivate
      rm -rf /tmp/venv-test
      echo ""

      echo "=== Testing installed tools ==="
      black --version || echo "black command not found in PATH"
      ruff --version || echo "ruff command not found in PATH"
      echo ""
      echo "=== Persistence test complete ==="
      echo ""

      echo "=== Testing PYTHONUSERBASE configuration ==="
      echo "PYTHONUSERBASE value:"
      echo "  $PYTHONUSERBASE"
      echo ""
      echo "Installing test package (toml) using pip --user..."
      pip install --break-system-packages --user toml
      echo ""
      echo "Verifying installation location:"
      pip show toml
      echo ""
      echo "Testing toml package with Python code:"
      python3 -c "import toml; data = toml.loads('[tool]\nname = \"test\"\n'); print(f'toml loaded successfully, parsed: {data}')"
      echo ""
      echo "Note: This test bypasses PEP 668 (externally-managed environment)."
      echo "      For production environments, consider using pipx for applications."
      echo ""

      bash -il

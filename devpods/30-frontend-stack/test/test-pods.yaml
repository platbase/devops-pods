apiVersion: v1
kind: Pod  
metadata:  
  name: devpods-30-test
  labels:
    name: devpods, frontend
spec: 
  volumes:
  - {name: "/tmp/.X11-unix", hostPath: {path: "/tmp/.X11-unix"}}
  - {name: ".vscode-server", hostPath: {path: "./test/.vscode-server"}}
  - {name: "test-data",      hostPath: {path: "./test/data"}}
  - {name: "test-workspace", hostPath: {path: "./test/workspace"}}
  containers:
  - name: frontend
    image: bizobj-container.net/pods/frontend-stack:latest
    stdin: true
    tty: true
    volumeMounts:
    - {mountPath: "/tmp/.X11-unix",       name: "/tmp/.X11-unix"}
    - {mountPath: "/root/.vscode-server", name: ".vscode-server" }
    - {mountPath: "/data",                name: "test-data" }
    - {mountPath: "/root/workspace",      name: "test-workspace" }
    env:
    - {name: "DISPLAY", value: "unix$DISPLAY"}
    command: 
    - 'bash'
    - '-ic'
    - |
      sleep 2s
      export
      set -x
      cat /etc/os-release
      node -v
      npm -v
      yarn -v
      pnpm -v
      python3 --version
      pip3 --version
      pipx --version
      uv --version
      go version
      set +x

      echo ""
      echo "=== Go: Go persistence configuration ==="
      echo "Environment variables:"
      env | grep -E '^(GOPATH|GOMODCACHE|GOCACHE)' || echo "Some environment variables not set"
      echo ""
      echo "Go environment:"
      go env GOPATH
      go env GOMODCACHE
      go env GOCACHE
      echo ""

      echo "=== Go: Installing Go tool (golangci-lint) ==="
      go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
      echo ""

      echo "=== Go: Verifying installation locations ==="
      echo "Go tool in PATH:"
      which golangci-lint || echo "golangci-lint not found in PATH"
      echo ""
      echo "Go executables in /data/go/bin:"
      ls -la /data/go/bin/ || echo "Directory not found"
      echo ""
      echo "Go module cache in /data/go/modcache:"
      ls -la /data/go/modcache/ 2>/dev/null | head -10 || echo "Directory not found or empty"
      
      echo ""
      echo "=== Go: Testing Go hello world with external module ==="
      mkdir -p /tmp/go-hello
      pushd /tmp/go-hello
      
      # Initialize Go module
      go mod init example.com/hello
      
      # Download external math module
      go get github.com/shopspring/decimal
      
      # Create Go code using external module
      echo 'package main' > main.go
      echo '' >> main.go
      echo 'import (' >> main.go
      echo '	"fmt"' >> main.go
      echo '	"github.com/shopspring/decimal"' >> main.go
      echo ')' >> main.go
      echo '' >> main.go
      echo 'func main() {' >> main.go
      echo '	fmt.Println("=== Go Hello World with External Module ===")' >> main.go
      echo '	' >> main.go
      echo '	// High-precision Pi calculation using decimal package' >> main.go
      echo '	pi := decimal.NewFromFloat(3.141592653589793238462643383279502884197169399375105820974944592307816406286208998628034825342117067982148086513282306647093844609550582231725359408128481117450284102701938521105559644622948954930381964428810975366593344612847564823378678316527120190914564856692346034861045432664821339360726024914127372458700660631558817488152092096282925948737687)' >> main.go
      echo '	' >> main.go
      echo '	// Calculate circle area with high precision' >> main.go
      echo '	radius := decimal.NewFromInt(5)' >> main.go
      echo '	radiusSquared := radius.Mul(radius)' >> main.go
      echo '	area := radiusSquared.Mul(pi)' >> main.go
      echo '	' >> main.go
      echo '	fmt.Printf("Pi value: %s\n", pi.String())' >> main.go
      echo '	fmt.Printf("Radius: %s\n", radius.String())' >> main.go
      echo '	fmt.Printf("Area: %s\n", area.String())' >> main.go
      echo '	' >> main.go
      echo '	fmt.Println("\\nHello, World!")' >> main.go
      echo '}' >> main.go
      
      # Use go install installed tool to check code
      echo "Running golangci-lint on code:"
      golangci-lint run || echo "Note: linting skipped or warnings"
      
      # Compile and run Go program
      echo "Running hello world:"
      go run main.go
      
      # Verify external module in cache
      echo ""
      echo "External module (decimal) in cache:"
      ls -la /data/go/modcache/github.com/shopspring/decimal*/ | head -5 || echo "Module not in modcache"
      
      # Cleanup
      popd
      rm -rf /tmp/go-hello
      echo ""

      echo "=== Go: Persistence test complete ==="
      echo ""
      
      echo ""
      echo "=== Python: Python persistence configuration ==="
      echo "Environment variables:"
      env | grep -E '^(PIPX_|UV_|PYTHONUSERBASE)' || echo "Some environment variables not set"
      echo ""
      echo "Pip configuration:"
      pip config list
      echo ""
      echo "Pipx environment:"
      pipx environment
      echo ""

      echo "=== Python: Testing PIPX packages installation (black, ruff) ==="
      pipx install black
      pipx install ruff
      echo ""
      black --version || echo "black command not found in PATH"
      ruff --version || echo "ruff command not found in PATH"
      echo ""

      echo "=== Python: Testing Python package in virtual environment ==="
      python3 -m venv /tmp/venv-test
      source /tmp/venv-test/bin/activate
      pip install requests
      echo ""
      echo "Directory structure in /data/python/:"
      ls -la /data/python/
      echo ""
      echo "Pipx symlinks in /data/python/pipx/bin/:"
      ls -la /data/python/pipx/bin/
      echo ""
      echo "Pipx venvs in /data/python/pipx/venvs/:"
      ls -la /data/python/pipx/venvs/
      echo ""
      echo "Pip package in virtual environment (/tmp/venv-test):"
      python3 -c "import requests; print(f'requests version: {requests.__version__}')"
      deactivate
      rm -rf /tmp/venv-test
      echo ""

      echo "=== Python: Testing PYTHONUSERBASE configuration ==="
      echo "PYTHONUSERBASE value:"
      echo "  $PYTHONUSERBASE"
      echo ""
      echo "Installing test package (toml) using pip --user..."
      pip install --break-system-packages --user toml
      echo ""
      echo "Verifying installation location:"
      pip show toml
      echo ""
      echo "Testing toml package with Python code:"
      python3 -c "import toml; data = toml.loads('[tool]\nname = \"test\"\n'); print(f'toml loaded successfully, parsed: {data}')"
      echo ""
      echo "Note: This test bypasses PEP 668 (externally-managed environment)."
      echo "      For production environments, consider using pipx for applications."
      echo ""

      echo "=== Python: Persistence test complete ==="

      bash -il
